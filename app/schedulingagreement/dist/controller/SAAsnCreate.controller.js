sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/export/Spreadsheet","sap/ui/export/library"],function(e,t,a,r){"use strict";return e.extend("sap.fiori.schedulingagreement.controller.SAAsnCreate",{onInit:function(){this.oDataModel=sap.ui.getCore().getModel("oDataModel");this.getView().addStyleClass("sapUiSizeCompact");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.asnModel=new sap.ui.model.json.JSONModel;this.asnModel.setSizeLimit(1e8);this.getView().setModel(this.asnModel,"asnModel");this.detailHeaderModel=new sap.ui.model.json.JSONModel;this.detailHeaderModel.setSizeLimit(1e3);this.getView().setModel(this.detailHeaderModel,"detailHeaderModel");this.getView().byId("AsnCreateTable").setSticky(["ColumnHeaders","HeaderToolbar"]);this.dateConfirmationModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.dateConfirmationModel,"DateConfirmationModel");this.popOverModel=new sap.ui.model.json.JSONModel;this.byId("uploadSet").attachEvent("openPressed",this.onOpenPressed,this)},handleRouteMatched:function(e){var a=this.getView().getModel();var r=this.byId("uploadSet");r.removeAllItems();if(e.getParameter("name")==="SAAsnCreate"){this.byId("totalInvNetAmnt").setValueState("None");this.byId("totalCGstAmnt").setValueState("None");this.byId("totalSGstAmnt").setValueState("None");this.byId("totalIGstAmnt").setValueState("None");this.byId("totalAmnt").setValueState("None");this.byId("ewayBillNumberId").setValueState("None");var s=this;this.getView().byId("AsnCreateTable").removeSelections(true);var i=new Date;this.getView().byId("DP1").setMaxDate(i);var o=e.getParameter("arguments").Schedule_No;this.Schedule_No=o.replace(/-/g,"/");var n=e.getParameter("arguments").UnitCode||"P01";this.AddressCodeSA=sessionStorage.getItem("AddressCodeSA")||"JSE-01-01";var a=this.getOwnerComponent().getModel();this.getView().setModel(new sap.ui.model.json.JSONModel({minDate:new Date}),"dateModel");var l="/SchedulingAgreements";a.read(l,{urlParameters:{$expand:"DocumentRows",AddressCode:this.AddressCodeSA,UnitCode:n,SchNum:this.Schedule_No},success:function(e){var a=e.results.find(e=>e.ScheduleNum===s.Schedule_No);if(a){s.detailHeaderModel.setData(a);s.detailHeaderModel.refresh(true);s.asnModel.setData(a);s.asnModel.refresh(true);var r=s.getView().getModel("asnModel").getData();for(var i=0;i<r.DocumentRows.results.length;i++){r.DocumentRows.results[i].Balance=parseFloat(r.DocumentRows.results[i].PoQty)-parseFloat(r.DocumentRows.results[i].ASNQty);r.DocumentRows.results[i].Pkg="0";r.DocumentRows.results[i].ASSValue=parseFloat(r.DocumentRows.results[i].Balance)*parseFloat(r.DocumentRows.results[i].UnitPrice);if(r.DocumentRows.results[i].IGST!=="0"){r.DocumentRows.results[i].IGA=parseFloat(r.DocumentRows.results[i].IGST)*parseFloat(r.DocumentRows.results[i].Balance)*parseFloat(r.DocumentRows.results[i].UnitPrice)/100}if(r.DocumentRows.results[i].CGST!=="0"){r.DocumentRows.results[i].CGA=parseFloat(r.DocumentRows.results[i].CGST)*parseFloat(r.DocumentRows.results[i].Balance)*parseFloat(r.DocumentRows.results[i].UnitPrice)/100}if(r.DocumentRows.results[i].SGST!=="0"){r.DocumentRows.results[i].SGA=parseFloat(r.DocumentRows.results[i].SGST)*parseFloat(r.DocumentRows.results[i].Balance)*parseFloat(r.DocumentRows.results[i].UnitPrice)/100}r.DocumentRows.results[i].LineValue=parseFloat(r.DocumentRows.results[i].ASSValue)+parseFloat(r.DocumentRows.results[i].IGA)+parseFloat(r.DocumentRows.results[i].CGA)+parseFloat(r.DocumentRows.results[i].SGA)}s.asnModel.refresh(true);s.initializeAPIS()}else{t.error("Schedule agreement not found")}},error:function(e){var a=JSON.parse(e.responseText);t.error(a.error.message.value)}})}sap.ui.core.BusyIndicator.hide()},initializeAPIS:function(){this.GetTransportModeList()},GetTransportModeList:function(){var e=this.getView().getModel();return new Promise(function(t,a){e.callFunction("/GetTransportModeList",{method:"GET",success:function(e,a){var r=e.results;var s=new sap.ui.model.json.JSONModel;s.setData({items:r});this.getView().setModel(s,"transport");t()}.bind(this),error:function(e){a(new Error("Failed to fetch transport data."))}})}.bind(this))},onNavBack:function(){jQuery.sap.require("sap.ui.core.routing.History");var e=sap.ui.core.routing.History.getInstance(),t=e.getPreviousHash();if(t!==undefined){history.go(-1)}else{var a=true;this.router.navTo("SAMaster",{},a)}},formatASNdates:function(e){const t=e.split("/");const a=parseInt(t[2],10);const r=parseInt(t[1],10)-1;const s=parseInt(t[0],10);const i=new Date(a,r,s);const o=i.getTimezoneOffset()*6e4;const n=new Date(i.getTime()-o);const l=n.toISOString().split("T")[0]+"T00:00:00";return l+"+05:30"},onAsnSave:function(e){var a=this;if(this.validateFields()){this.data=this.asnModel.getData();var r={UnitCode:this.data.PlantCode,CreatedBy:this.getOwnerComponent().getModel().getHeaders().loginId,CreatedIP:"",RowDetails:[]};var s=this.getView().byId("AsnCreateTable");var i=s.getSelectedContexts();if(!this.data.BillNumber&&!this.data.DeliveryNumber){t.error("Please fill Invoice Number or Delivery Number");return}if(this.data.BillNumber&&!this.data.BillDate){t.error("Please fill Invoice Date");return}if(this.data.DeliveryNumber&&!this.data.DeliveryDate){t.error("Please fill Delivery Date");return}if(this.data.EwayBillNumber===undefined){this.data.EwayBillNumber=""}if(!this.data.TotalInvNetAmnt){t.error("Please fill Total Invoice Net Amount");return}else if(!this.data.TotalCGstAmnt){t.error("Please fill Total CGST Amount");return}else if(!this.data.TotalSGstAmnt){t.error("Please fill Total SGST Amount");return}else if(!this.data.TotalIGstAmnt){t.error("Please fill Total IGST Amount");return}else if(!this.data.TotalAmnt){t.error("Please fill Total Amount");return}if(!this.item){t.error("Atleast one attachment is required");return}if(!i.length){t.error("No item selected");return}else{var o=i.map(function(e){return e.getObject()});for(var n=0;n<o.length;n++){let e=e=>e.every(t=>t.IGST===e[0].IGST);let a=e=>e.every(t=>t.CGST===e[0].CGST);let s=e=>e.every(t=>t.SGST===e[0].SGST);if(!e){t.error("Please select line items with same IGST %");sap.ui.core.BusyIndicator.hide();return}if(!a){t.error("Please select line items with same CGST %");sap.ui.core.BusyIndicator.hide();return}if(!s){t.error("Please select line items with same SGST %");sap.ui.core.BusyIndicator.hide();return}if(parseInt(o[n].LineNum)!==n+1){t.error("Please enter correct Bill Line No.");sap.ui.core.BusyIndicator.hide();return}if(!o[n].Balance){t.error("ASN Quantity is required for selected items");sap.ui.core.BusyIndicator.hide();return}else{if(this.data.BillDate){var l=this.data.BillDate.substring(4,6)+"/"+this.data.BillDate.substring(6,8)+"/"+this.data.BillDate.substring(0,4);var u=new Date(l);var d=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.BillDate=d.format(u);this.BillDate=this.formatASNdates(this.BillDate)}if(this.data.ManufacturingMonth===undefined){this.data.ManufacturingMonth=""}else if(this.data.ManufacturingMonth){var l=this.data.ManufacturingMonth.substring(4,6)+"/"+this.data.ManufacturingMonth.substring(6,8)+"/"+this.data.ManufacturingMonth.substring(0,4);var u=new Date(l);var d=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.ManufacturingMonth=d.format(u);this.ManufacturingMonth=this.formatASNdates(this.ManufacturingMonth)}if(o[n].TCS===undefined){o[n].TCS=""}if(o[n].TCA===undefined){o[n].TCA=""}if(this.data.TransportName===undefined){this.data.TransportName=""}if(this.data.TransportMode===undefined){this.data.TransportMode=""}if(this.data.DocketNumber===undefined){this.data.DocketNumber=""}if(this.data.GRDate===undefined){this.data.GRDate=""}else if(this.data.GRDate){var l=this.data.GRDate.substring(4,6)+"/"+this.data.GRDate.substring(6,8)+"/"+this.data.GRDate.substring(0,4);var u=new Date(l);var d=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.GRDate=d.format(u);this.GRDate=this.formatASNdates(this.GRDate)}if(this.data.EwayBillDate===undefined){this.data.EwayBillDate=""}else if(this.data.EwayBillDate){var l=this.data.EwayBillDate.substring(4,6)+"/"+this.data.EwayBillDate.substring(6,8)+"/"+this.data.EwayBillDate.substring(0,4);var u=new Date(l);var d=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});this.EwayBillDate=d.format(u);this.EwayBillDate=this.formatASNdates(this.EwayBillDate)}if(this.data.MillNumber===undefined){this.data.MillNumber=""}if(this.data.MillName===undefined){this.data.MillName=""}if(this.data.PDIRNumber===undefined){this.data.PDIRNumber=""}if(this.data.HeatNumber===undefined){this.data.HeatNumber=""}if(this.data.BatchNumber===undefined){this.data.BatchNumber=""}if(this.data.ManufacturingMonth===undefined){this.ManufacturingMonth=""}if(o[n].Packing===undefined){o[n].Packing="0"}if(o[n].Frieght===undefined){o[n].Frieght="0"}if(o[n].OtherCharges===undefined){o[n].OtherCharges="0"}var h={BillLineNumber:o[n].LineNum,BillDate:this.BillDate||this.data.DeliveryDate,BillNumber:this.data.BillNumber||this.data.DeliveryNumber,ScheduleNumber:o[n].SchNum_ScheduleNum,ScheduleLineNumber:o[n].SchLineNum,PONumber:o[n].PoNum,IAIVendorCode:this.data.VendorCode,IAIItemCode:o[n].ItemCode,UOM:o[n].UOM,HSNCode:o[n].HSNCode,Rate:o[n].UnitPrice,Quantity:o[n].Balance,PackingAmount:o[n].Packing,Freight:o[n].Frieght,OtherCharges:o[n].OtherCharges,AssValue:o[n].ASSValue.toString(),IGST:o[n].IGST,IGA:o[n].IGA,CGST:o[n].CGST,CGA:o[n].CGA,SGST:o[n].SGST,SGA:o[n].SGA,TCS:o[n].TCS,TCA:o[n].TCA,LineValue:o[n].LineValue,TransportName:this.data.TransportName,TransportMode:this.data.TransportMode,DocketNumber:this.data.DocketNumber,GRDate:this.data.GRDate,Packaging:"0",WeightPerKG:o[n].WeightInKG,EwayBillNumber:this.data.EwayBillNumber,EwayBillDate:this.EwayBillDate,MillNumber:this.data.MillNumber,MillName:this.data.MillName,PDIRNumber:this.data.PDIRNumber,HeatNumber:this.data.HeatNumber,BatchNumber:this.data.BatchNumber,ManufacturingMonth:this.data.ManufacturingMonth};r.RowDetails.push(h)}}var c="TOTAL AMOUNT = "+this.data.TotalAmnt+" INR"+"\n \n \n Are you sure you want to proceed for ASN generation?";t.confirm(c,{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CLOSE],icon:sap.m.MessageBox.Icon.QUESTION,styleClass:"messageText",onClose:function(e){if(e==="OK"){sap.ui.core.BusyIndicator.show();var s=JSON.stringify(r);this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.schedulingagreement")}var i=this.hardcodedURL+`/sa/odata/v4/catalog/PostASN`;$.ajax({type:"POST",headers:{loginid:a.getView().getModel().getHeaders().loginId,"Content-Type":"application/json"},url:i,data:JSON.stringify({asnData:s}),context:this,success:function(e,r,s){sap.ui.core.BusyIndicator.hide();this.AsnNum=e.d.PostASN;t.success(this.AsnNum+" ASN created succesfully",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(e){if(e==="OK"){sap.fiori.schedulingagreement.controller.formatter.onNavBack()}}});a.onAsnSaveDB(this.AsnNum)}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();var a=JSON.parse(e.responseText);t.error(a.error.message.value)}})}}})}}else{t.error("Eway Bill Number should be 12 digit");return}},onAsnSaveDB:function(e){var a=this.getOwnerComponent().getModel();this.data=this.asnModel.getData();var r={SchNum_ScheduleNum:this.data.ScheduleNum,AsnNum:e,BillDate:this.data.BillDate,BillNumber:this.data.BillNumber,DeliveryNumber:this.data.DeliveryNumber,DeliveryDate:this.data.DeliveryDate,DocketNumber:this.data.DocketNumber,GRDate:this.data.GRDate,TransportName:this.data.TransportName,TransportMode:this.data.TransportMode,EwayBillNumber:this.data.EwayBillNumber,EwayBillDate:this.data.EwayBillDate,MillNumber:this.data.MillNumber,MillName:this.data.MillName,PDIRNumber:this.data.PDIRNumber,HeatNumber:this.data.HeatNumber,BatchNumber:this.data.BatchNumber,ManufacturingMonth:this.data.ManufacturingMonth,PlantName:this.data.PlantName,PlantCode:this.data.PlantCode,VendorCode:this.data.VendorCode,TotalInvNetAmnt:this.data.TotalInvNetAmnt,TotalCGstAmnt:this.data.TotalCGstAmnt,TotalSGstAmnt:this.data.TotalSGstAmnt,TotalIGstAmnt:this.data.TotalIGstAmnt,TotalAmnt:this.data.TotalAmnt,TransporterID:this.data.TransporterID};var s=[];var i=this.getView().byId("AsnCreateTable");var o=i.getSelectedContexts();if(!r.BillNumber&&!r.DeliveryNumber){t.error("Please fill Invoice Number or Delivery Number");return}if(r.BillNumber&&!r.BillDate){t.error("Please fill Invoice Date");return}if(r.DeliveryNumber&&!r.DeliveryDate){t.error("Please fill Delivery Date");return}if(!r.TotalInvNetAmnt){t.error("Please fill Total Invoice Net Amount");return}else if(!r.TotalCGstAmnt){t.error("Please fill Total CGST Amount");return}else if(!r.TotalSGstAmnt){t.error("Please fill Total SGST Amount");return}else if(!r.TotalIGstAmnt){t.error("Please fill Total IGST Amount");return}else if(!r.TotalAmnt){t.error("Please fill Total Amount");return}if(!o.length){t.error("No Item Selected");return}else{var n=o.map(function(e){return e.getObject()});for(var l=0;l<n.length;l++){if(!n[l].Balance){t.error("ASN Quantity is required for selected items");sap.ui.core.BusyIndicator.hide();return}else{n[l].ASSValue=n[l].ASSValue.toString();n[l].CGA=n[l].CGA.toString();n[l].LineValue=n[l].LineValue.toString();n[l].SGA=n[l].SGA.toString();n[l].IGA=n[l].IGA.toString();s.push(n[l])}}a.create("/ASNListHeader",r,null,function(e,t){},function(e){try{var a=JSON.parse(e.response.body);t.error(a.error.message.value)}catch(a){var r=jQuery.parseXML(e.getParameter("responseText")).querySelector("message").textContent;t.error(r)}});for(var l=0;l<s.length;l++){a.create("/ASNList",s[l],null,function(e,t){},function(e){try{var a=JSON.parse(e.response.body);t.error(a.error.message.value)}catch(a){var r=jQuery.parseXML(e.getParameter("responseText")).querySelector("message").textContent;t.error(r)}})}var u=e.replace(/\//g,"-");this._createEntity(this.item,u).then(()=>{this._uploadContent(this.item,u)}).catch(e=>{console.log("Error: "+e)})}},handleLinkPress:function(e){if(!this._oPopover){this._oPopover=sap.ui.xmlfragment("sap.fiori.schedulingagreement.view.PricePopoverFragment",this);this.getView().addDependent(this._oPopover)}var t=e.getSource().getBindingContext("asnModel").sPath;var a=this.asnModel.getProperty(t);this.popOverModel.setData(a);this._oPopover.setModel(this.popOverModel);this._oPopover.openBy(e.getSource())},onAsnCancel:function(){this.router.navTo("PoSplit")},onQuanPress:function(e){var t=this;if(!this.QuantFrag){this.QuantFrag=sap.ui.xmlfragment("sap.fiori.schedulingagreement.view.SAFragRequiredQuan",this);this.getView().addDependent(this.QuantFrag)}var a=e.getSource().getBindingContext("asnModel").getPath();var r=this.asnModel.getProperty(a);this.oDataModel.read("/S_LINEITEMSSet?$filter=Schedule_No eq '"+r.Ebeln+"' and Schedule_Item eq '"+r.Ebelp+"' and Material_No eq '"+r.Matnr+"' and Uom eq '"+r.Uom+"'",null,null,false,function(e,a){t.popOverModel.setData(e);t.QuantFrag.setModel(t.popOverModel,"itemModel");t.popOverModel.refresh(true)});this.QuantFrag.openBy(e.getSource())},onAfterItemAdded:function(e){this.item=e.getParameter("item");this.invoiceNo=this.getView().byId("invoiceNumId").getValue()},onUploadCompleted:function(e){var t=this.byId("uploadSet");var a=e.getParameter("item");var r=a.getUploadUrl();var s=r;a.setUrl(s);t.getBinding("items").refresh();t.invalidate()},_createEntity:function(e,t){var a=this.getView().getModel();this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.schedulingagreement")}var r={AsnNum:t,mediaType:e.getMediaType(),fileName:e.getFileName(),size:e.getFileObject().size,url:this.hardcodedURL+`/sa/odata/v4/catalog/Files(AsnNum='${t}')/content`};return new Promise((e,s)=>{a.update(`/Files(AsnNum='${t}')`,r,{success:function(){e()},error:function(e){console.log("Error: ",e);s(e)}})})},_uploadContent:function(e,t){this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sap.fiori.schedulingagreement")}var a=this.hardcodedURL+`/sa/odata/v4/catalog/Files(AsnNum='${t}')/content`;e.setUploadUrl(a);var r=this.byId("uploadSet");r.setHttpRequestMethod("PUT");r.uploadItem(e)},onOpenPressed:function(e){e.preventDefault();var t=e.getParameter("item");this._fileName=t.getFileName();this._download(t).then(e=>{var t=window.URL.createObjectURL(e);var a=document.createElement("a");a.href=t;a.setAttribute("download",this._fileName);document.body.appendChild(a);a.click();document.body.removeChild(a)}).catch(e=>{console.log(e)})},_download:function(e){console.log("_download");var t={url:e.getUrl(),method:"GET",xhrFields:{responseType:"blob"}};return new Promise((e,a)=>{$.ajax(t).done((t,a,r)=>{e(t)}).fail(e=>{a(e)})})},onDeliveryCost:function(e){var t=this.getView().byId("invoiceAmtId").getValue().trim();unplannedAmount=Math.abs(parseFloat(unplannedAmount));unplannedAmount=unplannedAmount?unplannedAmount:0;var a=+t+ +unplannedAmount;this.getView().byId("invoiceValueId").setValue(a.toFixed(2))},onEditPress:function(e){this.byId("invoiceValueId").setEditable(true)},onDateFilter:function(e){var a=this.byId("FromDateId").getValue();var r=this.byId("ToDateId").getValue();var s=this.getView().byId("AsnCreateTable").getBinding("items");if(a||r){var i=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter({path:"ShipDate",operator:sap.ui.model.FilterOperator.LE,value1:r}),new sap.ui.model.Filter({path:"ShipDate",operator:sap.ui.model.FilterOperator.GE,value1:a})],and:true});s.filter(i)}else{t.error("No Dates are Selected")}},onDateFilterClear:function(e){this.byId("FromDateId").setValue("");this.byId("ToDateId").setValue("");this.getView().byId("AsnCreateTable").getBinding("items").filter([])},onLinkPress:function(e){var a=this;var r=e.getSource().getParent().getBindingContext("asnModel").getObject();if(!this._oPopoverFragment){this._oPopoverFragment=sap.ui.xmlfragment("sap.fiori.schedulingagreement.fragment.DatePopoverFragment",this);this._oPopoverFragment.setModel(this.dateConfirmationModel);this.getView().addDependent(this._oPopoverFragment)}this.oDataModel.read("/ConfirmationDateSet?$filter=Ebeln eq '"+r.Schedule_No+"'and Ebelp  eq '"+r.Ebelp+"' and Etens eq '"+r.Etenr+"'",null,null,false,function(e,t){a.dateConfirmationModel.setData(e);a.dateConfirmationModel.refresh(true)},function(e){var a=JSON.parse(e.response.body);t.error(a.error.message.value)});this._oPopoverFragment.openBy(e.getSource())},onTypeMissmatch:function(e){t.error("Only PDF files are allowed.")},onInvNoChange:function(e,t){this.byId(t).setValue("");if(e.getParameter("value")==""){this.getView().byId("uploadSet").setUploadEnabled(false)}else{this.getView().byId("uploadSet").setUploadEnabled(true)}},onFromDateChange:function(e){var t=this.getView().byId("FromDateId").getDateValue();this.getView().byId("ToDateId").setMinDate(t)},onMaterialLiveChange:function(e){var t=e.getParameter("newValue")||e.getParameter("query")||"";var a=[];if(t){a.push(new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.Contains,t));a.push(new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,t))}else{a.push(new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.EQ,""));a.push(new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,""))}this.byId("AsnCreateTable").getBinding("items").filter(new sap.ui.model.Filter({filters:a}))},onQuantityChange:function(e){const t=e.getParameter("newValue"),a=e.getSource().getParent().getBindingContext("asnModel").getObject();var r=e.getSource().getParent().getBindingContextPath().split("/")[3];var s=this.asnModel.getData().DocumentRows.results;s[r].Balance=t;s[r].ASSValue=parseFloat(s[r].Balance)*parseFloat(s[r].UnitPrice);if(s[r].Packing){s[r].ASSValue=parseFloat(s[r].ASSValue)+parseFloat(s[r].Packing)}if(s[r].Frieght){s[r].ASSValue=parseFloat(s[r].ASSValue)+parseFloat(s[r].Frieght)}if(s[r].OtherCharges){s[r].ASSValue=parseFloat(s[r].ASSValue)+parseFloat(s[r].OtherCharges)}if(s[r].IGST!=="0"){s[r].IGA=parseFloat(s[r].IGST)*parseFloat(s[r].Balance)*parseFloat(s[r].UnitPrice)/100}if(s[r].CGST!=="0"){s[r].CGA=parseFloat(s[r].CGST)*parseFloat(s[r].Balance)*parseFloat(s[r].UnitPrice)/100}if(s[r].SGST!=="0"){s[r].SGA=parseFloat(s[r].SGST)*parseFloat(s[r].Balance)*parseFloat(s[r].UnitPrice)/100}s[r].LineValue=parseFloat(s[r].ASSValue)+parseFloat(s[r].IGA)+parseFloat(s[r].CGA)+parseFloat(s[r].SGA);this.asnModel.refresh(true);this.onRowSelect()},onPackChange:function(e){const t=e.getParameter("value")||0;var a=e.getSource().getParent().getBindingContextPath().split("/")[3];var r=this.asnModel.getData().DocumentRows.results;r[a].Packing=t;if(r[a].Frieght===undefined){r[a].Frieght="0"}if(r[a].OtherCharges===undefined){r[a].OtherCharges="0"}r[a].ASSValue=parseFloat(r[a].Balance)*parseFloat(r[a].UnitPrice)+parseFloat(r[a].Packing)+parseFloat(r[a].Frieght)+parseFloat(r[a].OtherCharges);this.asnModel.refresh(true)},onFreightChange:function(e){const t=e.getParameter("value")||0;var a=e.getSource().getParent().getBindingContextPath().split("/")[3];var r=this.asnModel.getData().DocumentRows.results;r[a].Frieght=t;if(r[a].Packing===undefined){r[a].Packing="0"}if(r[a].OtherCharges===undefined){r[a].OtherCharges="0"}r[a].ASSValue=parseFloat(r[a].Balance)*parseFloat(r[a].UnitPrice)+parseFloat(r[a].Packing)+parseFloat(r[a].Frieght)+parseFloat(r[a].OtherCharges);this.asnModel.refresh(true)},onOtherChange:function(e){const t=e.getParameter("value")||0;var a=e.getSource().getParent().getBindingContextPath().split("/")[3];var r=this.asnModel.getData().DocumentRows.results;r[a].OtherCharges=t;if(r[a].Frieght===undefined){r[a].Frieght="0"}if(r[a].Packing===undefined){r[a].Packing="0"}r[a].ASSValue=parseFloat(r[a].Balance)*parseFloat(r[a].UnitPrice)+parseFloat(r[a].Packing)+parseFloat(r[a].Frieght)+parseFloat(r[a].OtherCharges);this.asnModel.refresh(true)},onRateOkChange:function(e){const t=e.getParameter("selected");this.asnModel.getData().DocumentRows.results.forEach(e=>{e.RateAggreed=t});this.asnModel.refresh(true)},onRateAgreedChange:function(e){const t=e.getParameter("selected");if(t){e.getSource().getBindingContext("asnModel").getObject().SupplierRate=0}this.asnModel.refresh(true)},onRowSelect:function(){let e,t=0,a=0,r=0,s=0,i=0;this.byId("AsnCreateTable").getSelectedItems().forEach(o=>{e=o.getBindingContext("asnModel").getObject();t+=parseFloat(e.Balance)*parseFloat(e.UnitPrice);if(parseFloat(e.CGST)!==0){a+=parseFloat(e.CGST)*parseFloat(e.Balance)*parseFloat(e.UnitPrice)/100}if(parseFloat(e.SGST)!==0){r+=parseFloat(e.SGST)*parseFloat(e.Balance)*parseFloat(e.UnitPrice)/100}if(parseFloat(e.IGST)!==0){s+=parseFloat(e.IGST)*parseFloat(e.Balance)*parseFloat(e.UnitPrice)/100}i=t+a+r+s});const o=this.byId("totalInvNetAmnt"),n=this.byId("totalCGstAmnt"),l=this.byId("totalSGstAmnt"),u=this.byId("totalIGstAmnt"),d=this.byId("totalAmnt");o.setValue(parseFloat(this.formatAmnt(t)));n.setValue(parseFloat(this.formatAmnt(a)));l.setValue(parseFloat(this.formatAmnt(r)));u.setValue(parseFloat(this.formatAmnt(s)));d.setValue(parseFloat(this.formatAmnt(i)));if(t===parseFloat(o.getValue())){o.setValueState("Success").setValueStateText("Amount Matched")}else{o.setValueState("Warning").setValueStateText("Amount Mismatch")}if(a===parseFloat(n.getValue())){n.setValueState("Success").setValueStateText("Amount Matched")}else{n.setValueState("Warning").setValueStateText("Amount Mismatch")}if(r===parseFloat(l.getValue())){l.setValueState("Success").setValueStateText("Amount Matched")}else{l.setValueState("Warning").setValueStateText("Amount Mismatch")}if(s===parseFloat(u.getValue())){u.setValueState("Success").setValueStateText("Amount Matched")}else{u.setValueState("Warning").setValueStateText("Amount Mismatch")}if(i===parseFloat(d.getValue())){d.setValueState("Success").setValueStateText("Amount Matched")}else{d.setValueState("Warning").setValueStateText("Amount Mismatch")}},onAmtChange:function(){let e,t=0,a=0,r=0,s=0,i;this.byId("AsnCreateTable").getSelectedItems().forEach(o=>{e=o.getBindingContext("asnModel").getObject();t+=parseFloat(e.Balance)*parseFloat(e.UnitPrice);if(parseFloat(e.CGST)!==0){a+=parseFloat(e.CGST)*parseFloat(e.Balance)*parseFloat(e.UnitPrice)/100}if(parseFloat(e.SGST)!==0){r+=parseFloat(e.SGST)*parseFloat(e.Balance)*parseFloat(e.UnitPrice)/100}if(parseFloat(e.IGST)!==0){s+=parseFloat(e.IGST)*parseFloat(e.Balance)*parseFloat(e.UnitPrice)/100}i=t+a+r+s});const o=this.byId("totalInvNetAmnt"),n=this.byId("totalCGstAmnt"),l=this.byId("totalSGstAmnt"),u=this.byId("totalIGstAmnt"),d=this.byId("totalAmnt");if(t===parseFloat(o.getValue())){o.setValueState("Success").setValueStateText("Amount Matched")}else{o.setValueState("Warning").setValueStateText("Amount Mismatch")}if(a===parseFloat(n.getValue())){n.setValueState("Success").setValueStateText("Amount Matched")}else{n.setValueState("Warning").setValueStateText("Amount Mismatch")}if(r===parseFloat(l.getValue())){l.setValueState("Success").setValueStateText("Amount Matched")}else{l.setValueState("Warning").setValueStateText("Amount Mismatch")}if(s===parseFloat(u.getValue())){u.setValueState("Success").setValueStateText("Amount Matched")}else{u.setValueState("Warning").setValueStateText("Amount Mismatch")}if(i===parseFloat(d.getValue())){d.setValueState("Success").setValueStateText("Amount Matched")}else{d.setValueState("Warning").setValueStateText("Amount Mismatch")}},validateFields:function(){var e=true,t=this.getView().byId("ewayBillNumberId"),a=t.getBinding("value");if(t.getValue()){try{a.getType().validateValue(t.getValue());t.setValueState("None");e=true}catch(a){t.setValueState("Error");e=false}}return e},formatAmnt:function(e){if(e){var t=sap.ui.core.format.NumberFormat.getFloatInstance({groupingEnabled:false,groupingSeparator:"",groupingSize:0,decimalSeparator:".",decimals:2});return t.format(e)}return"0.00"},onDataExport:function(){var e,t,r=[];var s=this.asnModel.getData().DocumentRows.results;if(s){t=this.getView().byId("AsnCreateTable").getColumns();r=[{label:"Bill Line No",property:"LineNum"},{label:"SCH No",property:"SchNum_ScheduleNum"},{label:"Schedule Line",property:"SchLineNum"},{label:"PO No",property:"PoNum"},{label:"IAI Item Code",property:"ItemCode"},{label:"UOM",property:"UOM"},{label:"HSN Code",property:"HSNCode"},{label:"Rate",property:"UnitPrice"},{label:"Currency",property:"Currency"},{label:"Scheduled Qty",property:"PoQty"},{label:"Delivered Qty",property:"DeliveredQty"},{label:"ASN/Transit Qty",property:"ASNQty"},{label:"Balance Qty",property:"Balance"},{label:"Packing Amt",property:"Packing"},{label:"Freight",property:"Frieght"},{label:"Other Charges",property:"OtherCharges"},{label:"Ass Value",property:"ASSValue"},{label:"IGST %",property:"IGST"},{label:"IGST Amt",property:"IGA"},{label:"CGST %",property:"CGST"},{label:"CGST Amt",property:"CGA"},{label:"SGST % / UGST %",property:"SGST"},{label:"SGST Amt / UGST Amt",property:"SGA"},{label:"Line Value",property:"LineValue"},{label:"WGT IN KG",property:"WeightInKG"},{label:"Pkg.",property:"Pkg"},{label:"Remarks(yyyyMMdd)",property:"MatExpDate"}];e={workbook:{columns:r},dataSource:s,fileName:"Scheduling Agreement Line Item Data.xlsx"};new a(e).build()}},onUpload:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var a=this;var r={};if(e&&window.FileReader){var s=new FileReader;s.onload=function(e){var s=e.target.result;var i=XLSX.read(s,{type:"binary"});i.SheetNames.forEach(function(e){r=XLSX.utils.sheet_to_row_object_array(i.Sheets[e])});if(i.SheetNames.length>1){t.error("Invalid excel, please try again");return}else{if(r.length!==0){const e=[];for(let t=0;t<r.length;t++){var o={};o.LineNum=r[t]["Bill Line No"];o.SchNum_ScheduleNum=r[t]["SCH No"];o.SchLineNum=r[t]["Schedule Line"];o.PoNum=r[t]["PO No"];o.ItemCode=r[t]["IAI Item Code"];o.UOM=r[t]["UOM"];o.HSNCode=r[t]["HSN Code"];o.UnitPrice=r[t]["Rate"];o.Currency=r[t]["Currency"];o.PoQty=r[t]["Scheduled Qty"];o.DeliveredQty=r[t]["Delivered Qty"];o.ASNQty=r[t]["ASN/Transit Qty"];o.Balance=r[t]["Balance Qty"];o.Packing=r[t]["Packing Amt"];o.Frieght=r[t]["Freight"];o.OtherCharges=r[t]["Other Charges"];o.ASSValue=r[t]["Ass Value"];o.IGST=r[t]["IGST %"];o.IGA=r[t]["IGST Amt"];o.CGST=r[t]["CGST %"];o.CGA=r[t]["CGST Amt"];o.SGST=r[t]["SGST % / UGST %"];o.SGA=r[t]["SGST Amt / UGST Amt"];o.LineValue=r[t]["Line Value"];o.WeightInKG=r[t]["WGT IN KG"];o.Pkg=r[t]["Pkg."];o.MatExpDate=r[t]["Remarks(yyyyMMdd)"];e.push(o)}a.asnModel.getData().DocumentRows.results=e;a.asnModel.refresh(true)}else{t.error("Invalid excel, please try again");return}}};s.onerror=function(e){console.log(e)};s.readAsBinaryString(e)}}})});